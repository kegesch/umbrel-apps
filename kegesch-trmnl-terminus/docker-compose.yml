version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: kegesch-trmnl-terminus_web_1
      APP_PORT: 2300
      PROXY_AUTH_ADD: "false"
    container_name: kegesch-trmnl-terminus_app_proxy_1

  init-permissions:
    image: ghcr.io/usetrmnl/terminus:0.43.0
    container_name: kegesch-trmnl-terminus_init_1
    user: root
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        mkdir -p /app/public/uploads/cache
        chown -R 1000:1000 /app/public/uploads
        echo "Permissions set successfully"
    volumes:
      - ${APP_DATA_DIR}/data/uploads:/app/public/uploads
    restart: "no"

  web:
    image: ghcr.io/usetrmnl/terminus:0.43.0
    init: true
    container_name: kegesch-trmnl-terminus_web_1
    environment:
      HANAMI_PORT: "2300"
      API_URI: http://${DEVICE_HOSTNAME}:2300
      APP_SECRET: ${APP_SEED}
      DATABASE_URL: postgres://terminus:terminus@kegesch-trmnl-terminus_database_1:5432/terminus
      KEYVALUE_URL: redis://:terminus@kegesch-trmnl-terminus_keyvalue_1:6379/0
    volumes:
      - ${APP_DATA_DIR}/data/uploads:/app/public/uploads
    restart: on-failure
    depends_on:
      init-permissions:
        condition: service_completed_successfully
      database:
        condition: service_healthy
      keyvalue:
        condition: service_healthy

  worker:
    image: ghcr.io/usetrmnl/terminus:0.43.0
    init: true
    container_name: kegesch-trmnl-terminus_worker_1
    command: bundle exec sidekiq -r ./config/sidekiq.rb
    environment:
      API_URI: http://${DEVICE_HOSTNAME}:2300
      APP_SECRET: ${APP_SEED}
      DATABASE_URL: postgres://terminus:terminus@kegesch-trmnl-terminus_database_1:5432/terminus
      KEYVALUE_URL: redis://:terminus@kegesch-trmnl-terminus_keyvalue_1:6379/0
    volumes:
      - ${APP_DATA_DIR}/data/uploads:/app/public/uploads
    restart: on-failure
    depends_on:
      init-permissions:
        condition: service_completed_successfully
      web:
        condition: service_started

  database:
    image: postgres:17-alpine
    container_name: kegesch-trmnl-terminus_database_1
    environment:
      POSTGRES_USER: terminus
      POSTGRES_PASSWORD: terminus
      POSTGRES_DB: terminus
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U terminus -d terminus"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  keyvalue:
    image: valkey/valkey:9-alpine
    container_name: kegesch-trmnl-terminus_keyvalue_1
    command: >
      valkey-server
      --requirepass terminus
      --maxmemory 512mb
      --maxmemory-policy noeviction
    volumes:
      - ${APP_DATA_DIR}/data/valkey:/data
    restart: on-failure
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "terminus", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
